<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumena Health ‚Äì Prototyp (Step 1‚Äì4)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#101f3b;
      --card:#0e1a31;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#60a5fa;
      --accent2:#34d399;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#22c55e;
      --border:rgba(148,163,184,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 10% 10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(52,211,153,.12), transparent 55%),
                  radial-gradient(900px 700px at 50% 100%, rgba(251,191,36,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{display:flex; flex-direction:column; min-height:100vh}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(14px);
      background: rgba(11,18,32,.65);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; gap:12px; max-width:1280px; margin:0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(52,211,153,.85));
      box-shadow:var(--shadow); position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:9px; border-radius:10px;
      background:rgba(11,18,32,.55); border:1px solid rgba(255,255,255,.15);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid var(--border); background:rgba(15,26,47,.65);
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      cursor:pointer; display:flex; gap:8px; align-items:center; transition:.15s ease;
      user-select:none;
    }
    .tab:hover{transform:translateY(-1px); border-color:rgba(96,165,250,.35)}
    .tab.active{color:var(--text); border-color:rgba(96,165,250,.55); background:rgba(16,31,59,.85)}

    .top-actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid var(--border); background:rgba(16,31,59,.8); color:var(--text);
      padding:9px 12px; border-radius:12px; font-size:12px; cursor:pointer; transition:.15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(52,211,153,.35)}
    .btn.primary{background:linear-gradient(135deg, rgba(96,165,250,.95), rgba(52,211,153,.75)); border-color:transparent}
    .btn.danger{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.35)}
    .pill{font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:rgba(15,26,47,.45)}

    /* Layout */
    .container{max-width:1280px; margin:0 auto; width:100%; padding:18px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:16px; align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{background:rgba(15,26,47,.7); border:1px solid var(--border); border-radius:var(--radius2); box-shadow:var(--shadow); overflow:hidden}
    .panel-header{padding:14px 14px 12px; border-bottom:1px solid var(--border); display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .panel-header h2{margin:0; font-size:13px}
    .panel-header .sub{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .panel-body{padding:14px}

    .section-title{font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); margin:4px 0 10px}

    /* Inputs */
    .field{margin:0 0 12px}
    .field label{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:12px; color:var(--text); margin:0 0 7px}
    .field label span{color:var(--muted); font-size:11px}
    .row{display:flex; gap:10px; align-items:center}
    input[type="text"], input[type="number"], select{
      width:100%; background:rgba(16,31,59,.65); border:1px solid var(--border); color:var(--text);
      padding:10px 10px; border-radius:12px; outline:none; font-size:12px;
    }
    input[type="range"]{width:100%}
    .toggle{display:flex; gap:8px; align-items:center; background:rgba(16,31,59,.45); border:1px solid var(--border); padding:9px 10px; border-radius:12px}
    .toggle input{accent-color: var(--accent)}
    .toggle .hint{font-size:11px; color:var(--muted)}

    /* Cards */
    .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px}
    .card{grid-column: span 6; background:rgba(14,26,49,.75); border:1px solid var(--border); border-radius:var(--radius2); box-shadow:var(--shadow); overflow:hidden; position:relative}
    .card.full{grid-column: span 12}
    @media (max-width: 980px){.card{grid-column:span 12}}
    .card-header{padding:14px; border-bottom:1px solid var(--border); display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .card-header h3{margin:0; font-size:13px}
    .card-header p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .badge{font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:rgba(16,31,59,.55); white-space:nowrap}
    .badge.ok{color:rgba(34,197,94,.95); border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .badge.warn{color:rgba(251,191,36,.95); border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.10)}
    .badge.danger{color:rgba(251,113,133,.95); border-color:rgba(251,113,133,.35); background:rgba(251,113,133,.10)}
    .card-body{padding:14px}

    /* Alert box */
    .alert{border-radius:14px; border:1px solid var(--border); background:rgba(16,31,59,.55); padding:12px 12px; display:flex; gap:10px; align-items:flex-start; margin:0 0 12px}
    .dot{width:10px; height:10px; border-radius:999px; margin-top:4px; flex:0 0 auto}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)}
    .alert .title{font-weight:600; font-size:12px; margin:0}
    .alert .desc{font-size:12px; margin:4px 0 0; color:var(--muted); line-height:1.45}

    /* Tables */
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    td,th{font-size:12px}
    th{color:var(--muted); font-weight:500; text-align:left; padding:0 10px 6px}
    .trow{background:rgba(16,31,59,.55); border:1px solid var(--border); border-radius:14px}
    .trow td{padding:10px}
    .trow td:first-child{border-top-left-radius:14px; border-bottom-left-radius:14px}
    .trow td:last-child{border-top-right-radius:14px; border-bottom-right-radius:14px}

    .value{font-family:var(--mono); font-size:12px}
    .flag{font-weight:600}
    .flag.ok{color:rgba(34,197,94,.95)}
    .flag.warn{color:rgba(251,191,36,.95)}
    .flag.danger{color:rgba(251,113,133,.95)}
    .mini{font-size:11px; color:var(--muted); margin-top:4px; line-height:1.35}
    .chip{display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(15,26,47,.35); color:var(--muted); margin:4px 6px 0 0}

    .pricing-grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .price-card{grid-column:span 4}
    @media (max-width: 1100px){.price-card{grid-column:span 6}}
    @media (max-width: 980px){.price-card{grid-column:span 12}}

    .price-card .card-body{display:flex; flex-direction:column; gap:10px}
    .price{font-size:22px; font-weight:700; letter-spacing:.2px}

    .divider{height:1px; background:var(--border); margin:12px 0}
    .split{display:grid; grid-template-columns:1.1fr .9fr; gap:12px}
    @media (max-width: 980px){.split{grid-template-columns:1fr}}

    /* Doctor dashboard */
    .kpi{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .kpi .k{grid-column:span 4}
    @media (max-width: 980px){.kpi .k{grid-column:span 12}}
    .k .big{font-size:22px; font-weight:800}
    .k .label{font-size:12px; color:var(--muted)}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{background:rgba(16,31,59,.55); border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; justify-content:space-between; gap:10px; align-items:flex-start; cursor:pointer; transition:.15s ease}
    .item:hover{transform:translateY(-1px); border-color:rgba(96,165,250,.35)}
    .item .meta{font-size:11px; color:var(--muted); margin-top:3px}
    .footnote{font-size:11px; color:var(--muted); line-height:1.45}

    .view{display:none}
    .view.active{display:block}

    .toast{position:fixed; right:16px; bottom:16px; background:rgba(15,26,47,.85); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:12px; width:min(420px, calc(100vw - 32px)); display:none; z-index:100}
    .toast.show{display:block}
    .toast .t{font-weight:700; font-size:12px; margin:0}
    .toast .d{font-size:12px; color:var(--muted); margin:6px 0 0; line-height:1.45}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Lumena Health</h1>
          <p>Ad-hoc Heimblutentnahme ‚Ä¢ Laboranalyse ‚Ä¢ KI-Assistenz ‚Ä¢ Kunden-Dashboard</p>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Steps">
        <div class="tab active" data-view="step12" role="tab" aria-selected="true">Step 1‚Äì2 <span class="pill">Pr√§analytik + KI</span></div>
        <div class="tab" data-view="step3" role="tab" aria-selected="false">Step 3 <span class="pill">Module & Checkout</span></div>
        <div class="tab" data-view="step4" role="tab" aria-selected="false">Step 4 <span class="pill">Kunden-Dashboard</span></div>
      </div>

      <div class="top-actions">
        <span class="pill" id="statusPill">Demo bereit</span>
        <button class="btn" id="resetBtn" title="Zur√ºcksetzen">‚Ü∫ Reset</button>
        <button class="btn primary" id="demoBtn" title="Demo-Daten laden">‚ö° Demo laden</button>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- VIEW: STEP 1‚Äì2 -->
    <div class="view active" id="view-step12">
      <div class="grid">

        <!-- Left Panel: Preanalytics -->
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Pr√§analytik-Check</h2>
              <p class="sub">Angaben vor der Blutentnahme. Das System markiert Werte, die durch Faktoren verf√§lscht sein k√∂nnen.</p>
            </div>
            <span class="badge" id="preBadge">Status: ‚Äî</span>
          </div>
          <div class="panel-body">

            <div class="section-title">N√ºchtern</div>
            <div class="field">
              <label>N√ºchtern? <span>f√ºr Glukose/Insulin/Lipide</span></label>
              <div class="toggle">
                <input type="checkbox" id="fasting" />
                <div>
                  <div style="font-size:12px; font-weight:600">Ja, n√ºchtern</div>
                  <div class="hint">Wenn nein: Stunden seit letzter Mahlzeit angeben</div>
                </div>
              </div>
            </div>
            <div class="field">
              <label>Stunden seit letzter Mahlzeit <span>(wenn nicht n√ºchtern)</span></label>
              <input type="number" id="hoursSinceMeal" min="0" max="24" value="0" />
            </div>

            <div class="section-title">Getr√§nke & Substanzen</div>
            <div class="field">
              <label>Kaffee / ges√ºsste Getr√§nke <span>letzte 6h</span></label>
              <select id="coffee">
                <option value="no">Nein</option>
                <option value="coffee">Kaffee (schwarz)</option>
                <option value="sweet">Ges√ºsstes Getr√§nk</option>
              </select>
            </div>
            <div class="field">
              <label>Alkohol <span>letzte 24h</span></label>
              <select id="alcohol">
                <option value="no">Nein</option>
                <option value="yes">Ja</option>
              </select>
            </div>
            <div class="field">
              <label>Supplements / Biotin <span>letzte 48h</span></label>
              <select id="biotin">
                <option value="no">Nein</option>
                <option value="yes">Ja (inkl. Biotin)</option>
              </select>
            </div>
            <div class="field">
              <label>Intensiver Sport <span>letzte 24h</span></label>
              <select id="sport">
                <option value="no">Nein</option>
                <option value="yes">Ja</option>
              </select>
            </div>
            <div class="field">
              <label>Raucherstatus <span>f√ºr CEA</span></label>
              <select id="smoke">
                <option value="no">Nicht-Raucher</option>
                <option value="yes">Raucher</option>
              </select>
            </div>

            <div class="divider"></div>
            <div class="footnote">Hinweis: Pr√§analytik-Hinweise sind **Assistenz**. Bei Unsicherheit wird eine Wiederholung oder √§rztliche R√ºcksprache empfohlen.</div>

          </div>
        </div>

        <!-- Right Panel: Modules & AI summary (Step 1‚Äì2) -->
        <div>
          <div class="card full">
            <div class="card-header">
              <div>
                <h3>Pr√§analytik-Warnbox (gesamt)</h3>
                <p>Automatisch aus den Angaben abgeleitet. Betroffene Werte werden im Modul zus√§tzlich markiert.</p>
              </div>
              <span class="badge" id="preSummaryBadge">‚Äî</span>
            </div>
            <div class="card-body" id="preAlertArea"></div>
          </div>

          <div class="cards">
            <div class="card" data-module="metabolic">
              <div class="card-header">
                <div>
                  <h3>‚ù§Ô∏è Stoffwechsel</h3>
                  <p>KI-Assistenz: Screening auf Dysglyk√§mie & metabolisches Risiko (ohne Diagnose).</p>
                </div>
                <span class="badge" id="badge-metabolic">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-metabolic"></tbody>
                </table>
                <div class="alert" id="ai-metabolic"></div>
              </div>
            </div>

            <div class="card" data-module="lipids">
              <div class="card-header">
                <div>
                  <h3>ü´Ä Lipide</h3>
                  <p>KI-Assistenz: Atherosklerose-Risiko, Therapieverlauf, Lifestyle-Impact.</p>
                </div>
                <span class="badge" id="badge-lipids">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-lipids"></tbody>
                </table>
                <div class="alert" id="ai-lipids"></div>
              </div>
            </div>

            <div class="card" data-module="cbc">
              <div class="card-header">
                <div>
                  <h3>ü©∏ Blutbild</h3>
                  <p>KI-Assistenz: An√§mie-/Entz√ºndungs-Hinweise, Verlauf & Kontext (ohne Diagnose).</p>
                </div>
                <span class="badge" id="badge-cbc">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-cbc"></tbody>
                </table>
                <div class="alert" id="ai-cbc"></div>
              </div>
            </div>

            <div class="card" data-module="kidney">
              <div class="card-header">
                <div>
                  <h3>üß¥ Niere</h3>
                  <p>KI-Assistenz: Filtration (eGFR/Kreatinin), Hydratation, Verlauf.</p>
                </div>
                <span class="badge" id="badge-kidney">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-kidney"></tbody>
                </table>
                <div class="alert" id="ai-kidney"></div>
              </div>
            </div>

            <div class="card" data-module="electrolytes">
              <div class="card-header">
                <div>
                  <h3>‚ö° Elektrolyte</h3>
                  <p>KI-Assistenz: Fl√ºssigkeit/Ern√§hrung/Medikation als Kontext (ohne Diagnose).</p>
                </div>
                <span class="badge" id="badge-electrolytes">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-electrolytes"></tbody>
                </table>
                <div class="alert" id="ai-electrolytes"></div>
              </div>
            </div>

            <div class="card" data-module="thyroid">
              <div class="card-header">
                <div>
                  <h3>üß† Schilddr√ºse</h3>
                  <p>KI-Assistenz: Abkl√§rung bei M√ºdigkeit, Gewicht, K√§lte-/W√§rmeintoleranz.</p>
                </div>
                <span class="badge" id="badge-thyroid">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-thyroid"></tbody>
                </table>
                <div class="alert" id="ai-thyroid"></div>
              </div>
            </div>

            <div class="card" data-module="micronutrients">
              <div class="card-header">
                <div>
                  <h3>ü•¶ Mikron√§hrstoffe</h3>
                  <p>KI-Assistenz: Eisenstatus, Vitamin D/B12 ‚Äì Energie/Immunsystem/Verlauf.</p>
                </div>
                <span class="badge" id="badge-micronutrients">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-micronutrients"></tbody>
                </table>
                <div class="alert" id="ai-micronutrients"></div>
              </div>
            </div>

            <div class="card" data-module="hormones">
              <div class="card-header">
                <div>
                  <h3>üß† Hormone & Stress</h3>
                  <p>KI-Assistenz: Stress-/Sexhormone im Kontext (ohne Diagnose).</p>
                </div>
                <span class="badge" id="badge-hormones">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-hormones"></tbody>
                </table>
                <div class="alert" id="ai-hormones"></div>
              </div>
            </div>

            <div class="card" data-module="liver">
              <div class="card-header">
                <div>
                  <h3>üß™ Leber & Entz√ºndung</h3>
                  <p>KI-Assistenz: Leberzellstress, Alkohol-/Medikament-Einfluss, systemische Entz√ºndung.</p>
                </div>
                <span class="badge" id="badge-liver">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                <tbody id="tbl-liver"></tbody>
                </table>
                <div class="alert" id="ai-liver"></div>
              </div>
            </div>

            <div class="card" data-module="muscle">
              <div class="card-header">
                <div>
                  <h3>üí™ Muskel / Belastung</h3>
                  <p>KI-Assistenz: CK/Troponin im Kontext von Sport/Trauma.</p>
                </div>
                <span class="badge" id="badge-muscle">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-muscle"></tbody>
                </table>
                <div class="alert" id="ai-muscle"></div>
              </div>
            </div>

            <div class="card" data-module="tumor">
              <div class="card-header">
                <div>
                  <h3>üß¨ Marker / CEA</h3>
                  <p>KI-Assistenz: Kontext zu CEA (Raucherstatus; nicht als Screening allein).</p>
                </div>
                <span class="badge" id="badge-tumor">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-tumor"></tbody>
                </table>
                <div class="alert" id="ai-tumor"></div>
              </div>
            </div>

            <div class="card" data-module="inflammation">
              <div class="card-header">
                <div>
                  <h3>üî• Entz√ºndung</h3>
                  <p>KI-Assistenz: Entz√ºndungsmarker im Verlauf (ohne Diagnose).</p>
                </div>
                <span class="badge" id="badge-inflammation">‚Äî</span>
              </div>
              <div class="card-body">
                <table>
                  <thead><tr><th>Wert</th><th>Resultat</th><th>Referenz</th><th>Status</th></tr></thead>
                  <tbody id="tbl-inflammation"></tbody>
                </table>
                <div class="alert" id="ai-inflammation"></div>
              </div>
            </div>

          </div>

          <div style="margin-top:14px" class="footnote">
            **Wichtiger Hinweis:** Dieses Demo-UI stellt keine Diagnose. Es unterst√ºtzt bei Interpretation, Pr√§analytik-Qualit√§t und sinnvollen Next Steps.
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: STEP 3 -->
    <div class="view" id="view-step3">
      <div class="cards">
        <div class="card full">
          <div class="card-header">
            <div>
              <h3>Step 3 ‚Äì Module, Preise & Checkout-Logik</h3>
              <p>Produktisierung: Kombinierbare Module + Add-ons. Checkout pr√ºft Pr√§analytik und macht sinnvolle Erg√§nzungsvorschl√§ge (Assistenz, kein Upsell-Druck).</p>
            </div>
            <span class="badge" id="checkoutBadge">Warenkorb: 0 Module</span>
          </div>
          <div class="card-body split">
            <div class="card" style="margin-bottom:12px">
              <div class="card-header">
                <div>
                  <h3>üè† Hausbesuch planen</h3>
                  <p>Servicegebiet (V5): Z√ºrich, Basel, Bern. Empfehlung passender Zeitfenster (morgens f√ºr n√ºchtern/Hormone).</p>
                </div>
                <span class="badge" id="visitFeeBadge">CHF ‚Äî</span>
              </div>
              <div class="card-body">
                <div class="field">
                  <label>Stadt <span>Servicegebiet</span></label>
                  <select id="visitCity">
                    <option value="Zuerich">Z√ºrich</option>
                    <option value="Basel">Basel</option>
                    <option value="Bern">Bern</option>
                  </select>
                </div>
                <div class="field">
                  <label>PLZ <span>Coverage Check (Demo)</span></label>
                  <input id="visitPLZ" type="text" inputmode="numeric" placeholder="z. B. 8000" maxlength="4" />
                  <div class="hint" id="visitPLZHint" style="margin-top:6px">‚Äî</div>
                </div>
                <div class="field">
                  <label>Terminfenster <span>Hausbesuch</span></label>
                  <select id="visitSlot"></select>
                  <div class="hint" id="visitSlotHint" style="margin-top:6px">‚Äî</div>
                </div>
                <div class="divider"></div>
                <div class="mini" id="visitPrepMini">Vorbereitung: Bitte Pr√§analytik in Step 1‚Äì2 ausf√ºllen.</div>
              </div>
            </div>

            <div>
              <div class="section-title">Module ausw√§hlen</div>
              <div class="pricing-grid" id="moduleGrid"></div>

              <div class="divider"></div>

              <div class="section-title">Add-ons</div>
              <div class="cards" style="grid-template-columns: repeat(12, 1fr); gap:12px">
                <div class="card" style="grid-column: span 6">
                  <div class="card-header">
                    <div>
                      <h3>üöÄ Express-Auswertung</h3>
                      <p>Priorisierte Verarbeitung (Demo).</p>
                    </div>
                    <span class="badge">+ CHF <span id="priceExpress">19</span></span>
                  </div>
                  <div class="card-body">
                    <div class="toggle">
                      <input type="checkbox" id="addonExpress" />
                      <div>
                        <div style="font-size:12px; font-weight:600">Express aktivieren</div>
                        <div class="hint">Bei hoher Qualit√§tswarnung wird Express deaktiviert.</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card" style="grid-column: span 6">
                  <div class="card-header">
                    <div>
                      <h3>ü©∫ Medizinische Einordnung (optional)</h3>
                      <p>Kurzkommentar oder kurzer Call.</p>
                    </div>
                    <span class="badge">ab CHF 29</span>
                  </div>
                  <div class="card-body">
                    <div class="field">
                      <label>W√§hle Option <span>optional</span></label>
                      <select id="addonDoctor">
                        <option value="none">Keine</option>
                        <option value="comment">Kurzkommentar (+29)</option>
                        <option value="call">15-min Call (+49)</option>
                      </select>
                    </div>
                    <div class="footnote">Assistenz, keine Notfallversorgung.</div>
                  </div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="section-title">KI-Checkout-Assistenz</div>
              <div id="checkoutAssist"></div>
            </div>

            <div>
              <div class="section-title">Warenkorb & Checkout</div>
              <div class="alert" id="cartAlert"></div>

              <div class="card" style="border-radius:18px; margin-bottom:12px">
                <div class="card-header">
                  <div>
                    <h3>Zusammenfassung</h3>
                    <p>Module, Add-ons, Pr√§analytik-Status, Gesamtpreis.</p>
                  </div>
                  <span class="badge" id="totalBadge">CHF 0</span>
                </div>
                <div class="card-body">
                  <div id="cartLines" class="list"></div>
                  <div class="divider"></div>
                  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px">
                    <div>
                      <div style="font-size:12px; color:var(--muted)">Gesamt</div>
                      <div class="price" id="totalPrice">CHF 0</div>
                      <div class="mini" id="totalMini">inkl. Laboranalyse & KI-Assistenz</div>
                    </div>
                    <button class="btn primary" id="payBtn">‚úÖ Checkout simulieren</button>
                  </div>
                </div>
              </div>

              <div class="footnote">
                Checkout-Logik (Demo): Hinweise ber√ºcksichtigen; Express nur wenn Qualit√§t ok.
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: STEP 4 -->
    <div class="view" id="view-step4">
      <div class="cards">
        <div class="card full">
          <div class="card-header">
            <div>
              <h3>Step 4 ‚Äì Kunden-Dashboard (Ergebnisse, Verlauf, Next Steps)</h3>
              <p>Resultate, Pr√§analytik-Kontext, KI-Zusammenfassung, Verlauf & n√§chste Schritte (ohne Diagnose).</p>
            </div>
            <span class="badge">My Health</span>
          </div>
          <div class="card-body">

            <div class="card" style="margin-bottom:12px">
              <div class="card-header">
                <div>
                  <h3>üìÖ Mein Hausbesuch</h3>
                  <p>Status & Vorbereitung f√ºr die Blutentnahme zu Hause.</p>
                </div>
                <span class="badge" id="visitStatusBadge">‚Äî</span>
              </div>
              <div class="card-body">
                <div style="display:flex; flex-wrap:wrap; gap:8px" id="visitJourney"></div>
                <div class="mini" id="visitMeta" style="margin-top:10px">‚Äî</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px">
                  <button class="btn secondary" id="visitToggleEnroute">üöó Unterwegs</button>
                  <button class="btn secondary" id="visitToggleDrawn">ü©∏ Abgenommen</button>
                  <button class="btn secondary" id="visitToggleLab">üß™ Im Labor</button>
                  <button class="btn" id="visitToggleReady">üìà Ergebnis bereit</button>
                  <button class="btn" id="visitToggleReset">‚Ü©Ô∏é Reset</button>
                </div>
              </div>
            </div>

            <div class="kpi" style="margin-bottom:12px">
              <div class="card k"><div class="card-body"><div class="big" id="kpiLast">‚Äî</div><div class="label">Letzte Auswertung</div></div></div>
              <div class="card k"><div class="card-body"><div class="big" id="kpiStatus">‚Äî</div><div class="label">Gesamtstatus</div></div></div>
              <div class="card k"><div class="card-body"><div class="big" id="kpiNext">‚Äî</div><div class="label">Empfohlener n√§chster Check</div></div></div>
            </div>

            <div class="split">
              <div>
                <div class="section-title">Meine Tests</div>
                <div class="list" id="custTimeline"></div>

                <div class="divider"></div>

                <div class="section-title">Aktionen</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn" id="btnDownload">‚¨áÔ∏è Bericht (PDF) herunterladen</button>
                  <button class="btn" id="btnCompare">üìà Verlauf vergleichen</button>
                  <button class="btn primary" id="btnRepeat">üîÅ Repeat planen</button>
                </div>
                <div class="mini" id="custActionHint" style="margin-top:10px">‚Äî</div>

                <div class="divider"></div>
                <div class="footnote">
                  Hinweis: Das Dashboard liefert **Assistenz** und Kontext. Bei starken Beschwerden oder Notfallzeichen bitte umgehend medizinische Hilfe suchen.
                </div>
              </div>

              <div>
                <div class="section-title">Auswertung</div>
                <div class="card" style="margin-bottom:12px">
                  <div class="card-header">
                    <div>
                      <h3 id="reportTitle">Test ausw√§hlen</h3>
                      <p id="reportMeta">‚Äî</p>
                    </div>
                    <span class="badge" id="reportBadge">‚Äî</span>
                  </div>
                  <div class="card-body">
                    <div id="reportPre"></div>
                    <div class="divider"></div>
                    <div class="alert" id="reportAI"></div>
                  </div>
                </div>

                <div class="card" style="margin-bottom:12px">
                  <div class="card-header">
                    <div>
                      <h3>üìå Fokuswerte (Verlauf)</h3>
                      <p>Trend (Demo). F√ºr Details siehe Module in Step 1‚Äì2.</p>
                    </div>
                    <span class="badge">Trends</span>
                  </div>
                  <div class="card-body">
                    <div id="trendGrid" style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px"></div>
                    <div class="mini" style="margin-top:10px" id="trendHint">‚Äî</div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <div>
                      <h3>üß≠ N√§chste Schritte</h3>
                      <p>Kontextbasierte Empfehlungen ‚Äì ohne Diagnose.</p>
                    </div>
                    <span class="badge">Assistenz</span>
                  </div>
                  <div class="card-body">
                    <div class="list" id="nextSteps"></div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
         <div class="card full" id="ordersCard" style="margin-top:12px">
      <div class="card-header">
        <div>
          <h3>Meine Tests ‚Äì Bestellungen</h3>
          <p>Stripe-Checkout ‚Üí Supabase <code>orders</code> (Filter nach E-Mail).</p>
        </div>
        <span class="badge">Orders</span>
      </div>
      <div class="card-body">
        <div class="row" style="margin-bottom:10px; gap:8px; flex-wrap:wrap">
          <input id="ordersEmail" type="email" placeholder="E-Mail f√ºr Filter" />
          <button class="btn" id="ordersRefresh">Refresh Orders</button>
          <span class="mini" id="ordersStatus">‚Äî</span>
        </div>
        <div style="overflow:auto">
          <table id="ordersTable" cellpadding="6" cellspacing="0" style="width:100%">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Status</th>
                <th>Betrag</th>
                <th>W√§hrung</th>
                <th>Stadt</th>
                <th>Slot</th>
                <th>Session</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast">
  <p class="t" id="toastT">‚Äî</p>
  <p class="d" id="toastD">‚Äî</p>
</div>

<script>
  // ---------------------------
  // Demo-Daten
  // ---------------------------
  const labs = {
    metabolic: [
      { key:"Glukose", unit:"mmol/L", value:5.2, ref:"3.9‚Äì5.5", low:3.9, high:5.5, pre:"fasting" },
      { key:"Insulin", unit:"mIU/L", value:10, ref:"2‚Äì25", low:2, high:25, pre:"fasting" },
      { key:"HOMA-IR (berechnet)", unit:"‚Äî", value:2.31, ref:"< 2.0", low:0, high:2.0, pre:"fasting" },
      { key:"C-Peptid", unit:"nmol/L", value:0.72, ref:"0.30‚Äì1.30", low:0.30, high:1.30, pre:"fasting" },
      { key:"HbA1c", unit:"%", value:5.4, ref:"4.0‚Äì5.6", low:4.0, high:5.6, pre:null }
    ],
    lipids: [
      { key:"Cholesterin gesamt", unit:"mmol/L", value:5.3, ref:"< 5.2", low:0, high:5.2, pre:"fasting" },
      { key:"LDL", unit:"mmol/L", value:3.1, ref:"< 3.0", low:0, high:3.0, pre:"fasting" },
      { key:"HDL", unit:"mmol/L", value:1.3, ref:"> 1.0", low:1.0, high:99, pre:"fasting" },
      { key:"Triglyceride", unit:"mmol/L", value:1.9, ref:"< 1.7", low:0, high:1.7, pre:"fasting" },
      { key:"ApoB", unit:"g/L", value:0.98, ref:"< 1.00", low:0, high:1.00, pre:"fasting" },
      { key:"Lp(a)", unit:"nmol/L", value:78, ref:"< 75", low:0, high:75, pre:null }
    ],
    cbc: [
      { key:"H√§moglobin", unit:"g/L", value:138, ref:"120‚Äì160", low:120, high:160, pre:null },
      { key:"H√§matokrit", unit:"L/L", value:0.41, ref:"0.36‚Äì0.46", low:0.36, high:0.46, pre:null },
      { key:"MCV", unit:"fL", value:90, ref:"80‚Äì96", low:80, high:96, pre:null },
      { key:"Leukozyten", unit:"G/L", value:6.2, ref:"4.0‚Äì10.0", low:4.0, high:10.0, pre:null },
      { key:"Thrombozyten", unit:"G/L", value:245, ref:"150‚Äì400", low:150, high:400, pre:null }
    ],
    kidney: [
      { key:"Kreatinin", unit:"¬µmol/L", value:88, ref:"62‚Äì106", low:62, high:106, pre:null },
      { key:"eGFR (CKD-EPI)", unit:"mL/min/1.73m¬≤", value:96, ref:"> 90", low:90, high:999, pre:null },
      { key:"Cystatin C", unit:"mg/L", value:0.88, ref:"0.60‚Äì1.00", low:0.60, high:1.00, pre:null },
      { key:"Harnstoff", unit:"mmol/L", value:6.4, ref:"2.8‚Äì7.2", low:2.8, high:7.2, pre:null },
      { key:"Harns√§ure", unit:"¬µmol/L", value:390, ref:"150‚Äì420", low:150, high:420, pre:null }
    ],
    electrolytes: [
      { key:"Natrium", unit:"mmol/L", value:140, ref:"135‚Äì145", low:135, high:145, pre:null },
      { key:"Kalium", unit:"mmol/L", value:4.2, ref:"3.5‚Äì5.1", low:3.5, high:5.1, pre:null },
      { key:"Chlorid", unit:"mmol/L", value:103, ref:"98‚Äì107", low:98, high:107, pre:null },
      { key:"Calcium", unit:"mmol/L", value:2.32, ref:"2.15‚Äì2.55", low:2.15, high:2.55, pre:null },
      { key:"Phosphat", unit:"mmol/L", value:1.12, ref:"0.80‚Äì1.50", low:0.80, high:1.50, pre:null },
      { key:"Magnesium", unit:"mmol/L", value:0.78, ref:"0.70‚Äì1.05", low:0.70, high:1.05, pre:null }
    ],
    thyroid: [
      { key:"TSH", unit:"mIU/L", value:2.2, ref:"0.4‚Äì4.0", low:0.4, high:4.0, pre:"biotin" },
      { key:"fT4", unit:"pmol/L", value:14, ref:"12‚Äì22", low:12, high:22, pre:"biotin" },
      { key:"fT3", unit:"pmol/L", value:5.2, ref:"3.1‚Äì6.8", low:3.1, high:6.8, pre:"biotin" },
      { key:"TPO-AK", unit:"kIU/L", value:55, ref:"< 35", low:0, high:35, pre:"biotin" },
      { key:"Tg-AK", unit:"kIU/L", value:22, ref:"< 115", low:0, high:115, pre:"biotin" }
    ],
    hormones: [
      { key:"Cortisol (8‚Äì10 Uhr)", unit:"nmol/L", value:410, ref:"170‚Äì540", low:170, high:540, pre:"coffee" },
      { key:"Testosteron gesamt", unit:"nmol/L", value:16.5, ref:"8‚Äì30", low:8, high:30, pre:null },
      { key:"SHBG", unit:"nmol/L", value:36, ref:"18‚Äì54", low:18, high:54, pre:null }
    ],
    liver: [
      { key:"ALT (GPT)", unit:"U/L", value:42, ref:"< 41", low:0, high:41, pre:"alcohol" },
      { key:"AST (GOT)", unit:"U/L", value:32, ref:"< 35", low:0, high:35, pre:"alcohol" },
      { key:"GGT", unit:"U/L", value:70, ref:"< 60", low:0, high:60, pre:"alcohol" },
      { key:"ALP", unit:"U/L", value:92, ref:"35‚Äì105", low:35, high:105, pre:null },
      { key:"Bilirubin gesamt", unit:"¬µmol/L", value:17, ref:"< 21", low:0, high:21, pre:null },
      { key:"Albumin", unit:"g/L", value:44, ref:"35‚Äì50", low:35, high:50, pre:null },
      { key:"INR", unit:"‚Äî", value:1.0, ref:"0.8‚Äì1.2", low:0.8, high:1.2, pre:null }
    ],
    inflammation: [
      { key:"hs-CRP", unit:"mg/L", value:1.2, ref:"< 3", low:0, high:3, pre:"sport" },
      { key:"BSG", unit:"mm/h", value:12, ref:"< 20", low:0, high:20, pre:null },
      { key:"Fibrinogen", unit:"g/L", value:3.6, ref:"2.0‚Äì4.0", low:2.0, high:4.0, pre:"sport" }
    ],
    micronutrients: [
      { key:"Ferritin", unit:"¬µg/L", value:42, ref:"30‚Äì300", low:30, high:300, pre:null },
      { key:"Eisen", unit:"¬µmol/L", value:12, ref:"9‚Äì30", low:9, high:30, pre:"fasting" },
      { key:"Transferrin", unit:"g/L", value:3.1, ref:"2.0‚Äì3.6", low:2.0, high:3.6, pre:null },
      { key:"Transferrin-S√§ttigung", unit:"%", value:18, ref:"20‚Äì50", low:20, high:50, pre:"fasting" },
      { key:"Vitamin D (25-OH)", unit:"nmol/L", value:58, ref:"> 75", low:75, high:999, pre:null },
      { key:"Vitamin B12", unit:"pmol/L", value:260, ref:"145‚Äì569", low:145, high:569, pre:"biotin" },
      { key:"Folat", unit:"nmol/L", value:13, ref:"> 10", low:10, high:999, pre:null },
      { key:"Vitamin B6 (PLP)", unit:"nmol/L", value:45, ref:"20‚Äì125", low:20, high:125, pre:"fasting" },
      { key:"Zink", unit:"¬µmol/L", value:11, ref:"10‚Äì18", low:10, high:18, pre:"fasting" },
      { key:"Selen", unit:"¬µg/L", value:82, ref:"70‚Äì130", low:70, high:130, pre:"fasting" },
      { key:"Homocystein", unit:"¬µmol/L", value:13.2, ref:"< 12", low:0, high:12, pre:"fasting" },
      { key:"Omega-3 Index (Demo)", unit:"%", value:4.2, ref:"> 8", low:8, high:999, pre:null }
    ],
    muscle: [
      { key:"CK", unit:"U/L", value:320, ref:"< 190", low:0, high:190, pre:"sport" },
      { key:"Troponin", unit:"ng/L", value:7, ref:"< 14", low:0, high:14, pre:"sport" }
    ],
    tumor: [
      { key:"CEA", unit:"¬µg/L", value:3.8, ref:"< 3.0", low:0, high:3.0, pre:"smoke" }
    ]
  };

  const moduleCatalog = [
    { id:"base", name:"ü©∏ Basis-Check", price:59, desc:"Glukose, CRP, Leber/Niere + √úberblick.", chips:["√úberblick","Entz√ºndung","Leber/Niere"] },
    { id:"cbc", name:"üßæ Blutbild (BB)", price:49, desc:"H√§moglobin/Leukozyten/Thrombozyten.", chips:["An√§mie-Hinweise","Entz√ºndung","Basics"] },
    { id:"cardio", name:"‚ù§Ô∏è Herz & Stoffwechsel", price:79, desc:"Stoffwechsel + Lipide.", chips:["Pr√§vention","Risiko","Lifestyle"], requiresFastingHint:true },
    { id:"lipidplus", name:"ü´Ä Lipide Advanced", price:89, desc:"ApoB + Lp(a).", chips:["ApoB","Lp(a)","Risikoprofil"], requiresFastingHint:true },
    { id:"liverplus", name:"üß™ Leber komplett", price:69, desc:"ALT/AST/GGT/ALP/Bilirubin.", chips:["Leber","Verlauf","Lifestyle"], preSensitive:["alcohol"] },
    { id:"kidney", name:"üßä Niere & Elektrolyte", price:69, desc:"Kreatinin/eGFR, Na/K/Ca/Mg.", chips:["Niere","Elektrolyte","Hydration"] },
    { id:"hormone", name:"üß† Schilddr√ºse & Hormone", price:89, desc:"TSH/fT3/fT4 + Cortisol/Testosteron.", chips:["Energie","Stress","Hormone"], preSensitive:["biotin","coffee"] },
    { id:"micros", name:"ü•ó Mikron√§hrstoffe", price:79, desc:"Ferritin/Eisen, Vit D/B12/Folat, Zink/Selen, Homocystein.", chips:["Energie","Immunsystem","Regeneration"], preSensitive:["fasting","biotin"] },
    { id:"performance", name:"üí™ Performance", price:79, desc:"Belastungsmarker (CK/Troponin).", chips:["Sport","Regeneration","Belastung"], preSensitive:["sport"] },
    { id:"inflammation", name:"üî• Entz√ºndung", price:59, desc:"hs-CRP, BSG, Fibrinogen.", chips:["Entz√ºndung","Verlauf","Kontext"], preSensitive:["sport"] },
    { id:"longevity", name:"üß¨ Longevity", price:99, desc:"Trendmarker (Demo).", chips:["Pr√§vention","Trend"] }
  ];

  const addOnPrices = { express:19, comment:29, call:49 };

  const visitCities = {
    Zuerich: { label:'Z√ºrich', fee:39, express:true },
    Basel:   { label:'Basel',  fee:35, express:true },
    Bern:    { label:'Bern',   fee:37, express:false }
  };
  const visitSlots = [
    { id:'0709', label:'07:00 ‚Äì 09:00', tag:'ideal n√ºchtern / Hormone' },
    { id:'0911', label:'09:00 ‚Äì 11:00', tag:'gut f√ºr die meisten Module' },
    { id:'1618', label:'16:00 ‚Äì 18:00', tag:'eher nicht n√ºchtern' }
  ];
  const coverageRules = {
    Zuerich: { re:/^(80|81)\d{2}$/, example:'8000' },
    Basel:   { re:/^40\d{2}$/,        example:'4000' },
    Bern:    { re:/^30\d{2}$/,        example:'3000' }
  };

  function normalizePLZ(v){ return (v||'').toString().trim().replace(/\s+/g,'').slice(0,4); }
  function validateCoverage(cityKey, plz){
    const rule = coverageRules[cityKey]; const p = normalizePLZ(plz);
    if(!p) return { ok:false, msg:`Bitte PLZ eingeben (z. B. ${rule?.example || '8000'}).` };
    if(p.length !== 4 || !/^\d{4}$/.test(p)) return { ok:false, msg:'PLZ muss 4-stellig sein.' };
    if(rule && !rule.re.test(p)) return { ok:false, msg:`Aktuell nur Servicegebiet ${visitCities[cityKey]?.label || cityKey} (Demo). Beispiel: ${rule.example}.` };
    return { ok:true, msg:`‚úÖ Abgedeckt in ${visitCities[cityKey]?.label || cityKey} (Demo).` };
  }
  function needsMorningSlot(){
    const selected = [...state.selectedModules];
    const fastingNeeded = selected.some(id=> moduleCatalog.find(x=>x.id===id)?.requiresFastingHint);
    const hormoneSelected = selected.includes('hormone');
    return fastingNeeded || hormoneSelected || state.pre.fasting;
  }
  function recommendedSlotIds(){ return needsMorningSlot() ? ['0709','0911'] : ['0911','1618']; }

  // ---------------------------
  // State
  // ---------------------------
  const state = {
    pre:{ fasting:false, hoursSinceMeal:0, coffee:'no', alcohol:'no', biotin:'no', sport:'no', smoke:'no' },
    selectedModules:new Set(),
    addOns:{ express:false, doctor:'none' },
    checkout:{ hardBlock:false, warnings:[], suggestions:[] },
    visit:{ city:'Zuerich', plz:'', covered:false, slot:'', fee:0, status:'unbooked', when:'' },
    customer:{ reports:[], activeReportId:null, history:[] }
  };

  // ---------------------------
  // Helpers
  // ---------------------------
  function fmtCHF(n){ return `CHF ${Math.round(n)}`; }
  function flagFor(value, low, high){ if(value<low) return 'warn'; if(value>high) return (value>high*1.3?'danger':'warn'); return 'ok'; }
  function preIssues(){
    const p = state.pre; const issues=[];
    if(!p.fasting && Number(p.hoursSinceMeal||0) < 8){ issues.push({level:'warn', title:'Nicht n√ºchtern', desc:`Letzte Mahlzeit vor ${p.hoursSinceMeal}h.`}); }
    if(p.coffee==='sweet') issues.push({level:'warn', title:'Ges√ºsstes Getr√§nk', desc:'Kurzfristiger Einfluss auf Glukose/Insulin m√∂glich.'});
    if(p.coffee==='coffee') issues.push({level:'warn', title:'Kaffee (schwarz)', desc:'Kann Stresshormone/Glukose leicht beeinflussen.'});
    if(p.alcohol==='yes') issues.push({level:'warn', title:'Alkohol in letzten 24h', desc:'Leberwerte/Triglyceride k√∂nnen erh√∂ht sein.'});
    if(p.biotin==='yes') issues.push({level:'warn', title:'Biotin/Supplements', desc:'Kann immunologische Tests verf√§lschen.'});
    if(p.sport==='yes') issues.push({level:'warn', title:'Intensiver Sport (24h)', desc:'CK/Troponin/Entz√ºndung k√∂nnen erh√∂ht sein.'});
    if(p.smoke==='yes') issues.push({level:'warn', title:'Raucherstatus', desc:'CEA h√∂her; Kontext beachten.'});
    const hard = issues.length>=3;
    return {issues, hard};
  }
  function preAffectsTag(test){
    const p = state.pre, map = {
      fasting: (!p.fasting && Number(p.hoursSinceMeal||0) < 8) || p.coffee!=='no',
      alcohol: p.alcohol==='yes',
      biotin:  p.biotin==='yes',
      sport:   p.sport==='yes',
      smoke:   p.smoke==='yes',
      coffee:  p.coffee!=='no'
    };
    if(!test.pre) return null; return map[test.pre] ? test.pre : null;
  }
  function preChipText(kind){
    return {
      fasting:'Pr√§analytik: nicht n√ºchtern',
      coffee:'Pr√§analytik: Kaffee/Drink',
      alcohol:'Pr√§analytik: Alkohol',
      biotin:'Pr√§analytik: Biotin',
      sport:'Pr√§analytik: Sport',
      smoke:'Pr√§analytik: Raucherstatus'
    }[kind] || 'Pr√§analytik';
  }
  function renderAlert(el, level, title, desc){ if(!el) return; el.innerHTML = `<div class="dot ${level}"></div><div><p class="title">${title}</p><p class="desc">${desc}</p></div>`; }
  function toast(title, desc){ const t=document.getElementById('toast'); if(!t) return; document.getElementById('toastT').textContent=title; document.getElementById('toastD').textContent=desc; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3200); }

  // ---------------------------
  // Step 1‚Äì2 rendering
  // ---------------------------
  function renderPreSummary(){
    const {issues, hard} = preIssues();
    const area = document.getElementById('preAlertArea');
    const badge = document.getElementById('preBadge');
    const badge2 = document.getElementById('preSummaryBadge');
    if(!area||!badge||!badge2) return;

    if(issues.length===0){
      area.innerHTML = `<div class="alert"><div class="dot ok"></div><div><p class="title">Keine Pr√§analytik-Hinweise</p><p class="desc">Angaben sprechen f√ºr gute Vergleichbarkeit.</p></div></div>`;
      badge.textContent = 'Status: OK'; badge.className='badge ok';
      badge2.textContent = 'OK'; badge2.className='badge ok';
    } else {
      area.innerHTML = issues.map(i=>`<div class="alert"><div class="dot ${i.level}"></div><div><p class="title">${i.title}</p><p class="desc">${i.desc}</p></div></div>`).join('');
      badge.textContent = hard ? 'Status: kritisch' : 'Status: Hinweise';
      badge.className = hard ? 'badge danger' : 'badge warn';
      badge2.textContent = hard ? 'Kritisch' : `${issues.length} Hinweis(e)`;
      badge2.className = hard ? 'badge danger' : 'badge warn';
    }
  }

  function renderModuleTable(moduleKey){
    const tbody = document.getElementById(`tbl-${moduleKey}`); if(!tbody) return;
    const data = labs[moduleKey];
    tbody.innerHTML = data.map(test=>{
      const fl = flagFor(test.value, test.low, test.high);
      const pre = preAffectsTag(test); const preHtml = pre ? `<div class="mini">‚ö† ${preChipText(pre)}</div>` : '';
      return `<tr class="trow">
        <td><div style="font-weight:600">${test.key}</div><div class="mini">${test.unit}</div></td>
        <td class="value">${test.value}</td><td class="value">${test.ref}</td>
        <td><div class="flag ${fl}">${fl==='ok'?'OK':(fl==='danger'?'Kritisch':'Auff√§llig')}</div>${preHtml}</td>
      </tr>`;
    }).join('');

    // Badges + AI
    const flags = data.map(t=>flagFor(t.value,t.low,t.high));
    const crit = flags.filter(f=>f==='danger').length; const warn = flags.filter(f=>f==='warn').length;
    const badge = document.getElementById(`badge-${moduleKey}`);
    if(badge){
      if(crit>0){ badge.textContent=`Auff√§llig: ${crit+warn} (kritisch: ${crit})`; badge.className='badge danger'; }
      else if(warn>0){ badge.textContent=`Auff√§llig: ${warn}`; badge.className='badge warn'; }
      else { badge.textContent='Keine Auff√§lligkeiten'; badge.className='badge ok'; }
    }
    const ai = document.getElementById(`ai-${moduleKey}`);
    const hasPre = data.some(t=>preAffectsTag(t));
    const preLine = hasPre ? 'Pr√§analytik: ‚ö† Hinweise vorhanden.' : 'Pr√§analytik: keine relevanten Hinweise.';
    let next = '';
    if(moduleKey==='metabolic'){ next = crit? 'Zeitnahe Abkl√§rung erw√§gen.' : (warn? 'Lifestyle & Verlauf in 8‚Äì12 Wochen.' : 'Optional Verlauf 6‚Äì12 Monate.'); }
    if(moduleKey==='lipids'){ next = crit? '√Ñrztliche Einordnung (Risiko/Therapie).' : (warn? 'Ern√§hrung/Bewegung, ggf. ApoB.' : 'Verlauf 6‚Äì12 Monate.'); }
    if(moduleKey==='thyroid'){ next = (warn||crit)? 'Kontext/Symptome beachten; ggf. Wiederholen.' : 'Nur bei Symptomen/Verlauf.'; }
    if(moduleKey==='liver'){ next = (warn||crit)? 'Alkohol/Medikation pr√ºfen; Verlauf 2‚Äì4 Wochen.' : 'Optional j√§hrlicher Verlauf.'; }
    if(moduleKey==='muscle'){ next = (warn||crit)? 'Sportpause 48‚Äì72h; bei Brustschmerz √§rztlich abkl√§ren.' : 'Nur bei Beschwerden/Verlauf.'; }
    if(moduleKey==='tumor'){ next = (warn||crit)? 'CEA unspezifisch; Kontext wichtig.' : 'Nicht als Screening allein.'; }
    if(moduleKey==='kidney'){ next = (warn||crit)? 'Hydration/Medikation pr√ºfen; Blutdruck/Urintest erw√§gen.' : 'Verlauf je nach Risiko.'; }
    if(moduleKey==='electrolytes'){ next = (warn||crit)? 'Fl√ºssigkeit/Ern√§hrung/Medikamente pr√ºfen.' : 'Meist nur bei Beschwerden relevant.'; }
    if(moduleKey==='micronutrients'){ next = (warn||crit)? 'Ern√§hrung/Supplemente anpassen; Verlauf 8‚Äì12 Wochen.' : 'Optional saisonaler Verlauf (Vit D).' ; }
    if(moduleKey==='hormones'){ next = (warn||crit)? 'Tageszeit/Stress/Schlaf ber√ºcksichtigen; ggf. morgens wiederholen.' : 'Nur bei Symptomen/Fragestellung.'; }
    if(moduleKey==='inflammation'){ next = (warn||crit)? 'Infekt/Belastung ber√ºcksichtigen; Verlauf einplanen.' : 'Nur bei Beschwerden/Profil.'; }

    if(ai){
      if(crit>0) renderAlert(ai,'danger','KI-Zusammenfassung',`Auff√§lligkeiten: ${crit+warn} (kritisch: ${crit}). ${next} ${preLine}`);
      else if(warn>0) renderAlert(ai,'warn','KI-Zusammenfassung',`Auff√§lligkeiten: ${warn}. ${next} ${preLine}`);
      else renderAlert(ai,'ok','KI-Zusammenfassung',`Keine Auff√§lligkeiten. ${next} ${preLine}`);
    }
  }
  function renderAllStep12(){
    renderPreSummary();
    ['metabolic','lipids','cbc','kidney','electrolytes','thyroid','micronutrients','hormones','liver','muscle','tumor','inflammation'].forEach(renderModuleTable);
  }

  // ---------------------------
  // Step 3 ‚Äì Module & Checkout
  // ---------------------------
  function renderModuleGrid(){
    const grid=document.getElementById('moduleGrid'); if(!grid) return;
    grid.innerHTML = moduleCatalog.map(m=>{
      const sel = state.selectedModules.has(m.id);
      return `<div class="card price-card">
        <div class="card-header"><div><h3>${m.name}</h3><p>${m.desc}</p></div><span class="badge">${fmtCHF(m.price)}</span></div>
        <div class="card-body">
          <div class="features">${m.chips.map(c=>`<span class="chip">${c}</span>`).join('')}</div>
          <div class="divider"></div>
          <button class="btn ${sel?'danger':'primary'}" data-toggle-module="${m.id}">${sel?'Entfernen':'Hinzuf√ºgen'}</button>
          ${m.requiresFastingHint?`<div class="mini">‚ö† N√ºchtern (8‚Äì12h) empfohlen.</div>`:''}
          ${m.preSensitive?`<div class="mini">‚ö† Sensitiv f√ºr: ${m.preSensitive.map(preChipText).join(', ')}</div>`:''}
        </div>
      </div>`;
    }).join('');
    grid.querySelectorAll('[data-toggle-module]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id=btn.getAttribute('data-toggle-module');
        if(state.selectedModules.has(id)) state.selectedModules.delete(id); else state.selectedModules.add(id);
        updateStep3();
      });
    });
  }
  function recommendedSlotText(){
    const recIds=recommendedSlotIds();
    const labels=visitSlots.filter(v=>recIds.includes(v.id)).map(v=>v.label).join(' oder ');
    return needsMorningSlot()? `Empfohlen: morgens (${labels})` : `Empfehlung: ${labels}`;
  }
  function renderVisitControls(){
    const citySel=document.getElementById('visitCity');
    const slotSel=document.getElementById('visitSlot');
    const plzInp=document.getElementById('visitPLZ');
    if(!citySel||!slotSel) return;
    citySel.value=state.visit.city;
    if(plzInp){
      plzInp.value=state.visit.plz||'';
      plzInp.placeholder=`z. B. ${coverageRules[state.visit.city]?.example||'8000'}`;
      const res=validateCoverage(state.visit.city, plzInp.value); state.visit.covered=res.ok;
      const hint=document.getElementById('visitPLZHint'); if(hint){ hint.textContent=res.msg; hint.style.color=res.ok?'var(--accent2)':'var(--warn)';}
    }
    slotSel.innerHTML=visitSlots.map(s=>`<option value="${s.label}">${s.label}</option>`).join('');
    if(!state.visit.slot) state.visit.slot=visitSlots[0].label;
    slotSel.value=state.visit.slot;
    const city=visitCities[state.visit.city];
    const feeBadge=document.getElementById('visitFeeBadge'); if(feeBadge) feeBadge.textContent=city?fmtCHF(city.fee):'CHF ‚Äî';
    const hintEl=document.getElementById('visitSlotHint'); if(hintEl) hintEl.textContent=`Hinweis: ${visitSlots.find(x=>x.label===state.visit.slot)?.tag||'‚Äî'} ‚Ä¢ ${recommendedSlotText()}`;
    const bits=[]; if(!state.pre.fasting) bits.push('N√ºchtern (falls Modul)'); if(state.pre.biotin==='yes') bits.push('Biotin pausieren'); if(state.pre.sport==='yes') bits.push('Sportpause 24‚Äì48h'); if(state.pre.alcohol==='yes') bits.push('Kein Alkohol 24h');
    const prep=document.getElementById('visitPrepMini'); if(prep) prep.textContent=bits.length?`Vorbereitung: ${bits.join(' ¬∑ ')}`:'Vorbereitung: Alles sieht gut aus.';
    const ex=document.getElementById('addonExpress'); if(city && !city.express && ex && ex.checked){ ex.checked=false; state.addOns.express=false; toast('Express angepasst', `In ${city.label} aktuell nicht verf√ºgbar (Demo).`); }
  }
  function bindVisit(){
    const citySel=document.getElementById('visitCity'); const slotSel=document.getElementById('visitSlot'); const plzInp=document.getElementById('visitPLZ');
    if(!citySel||!slotSel) return;
    citySel.addEventListener('change', ()=>{ state.visit.city=citySel.value; updateStep3(); });
    if(plzInp){ plzInp.addEventListener('input', ()=>{ state.visit.plz=normalizePLZ(plzInp.value); plzInp.value=state.visit.plz; updateStep3(); }); }
    slotSel.addEventListener('change', ()=>{ state.visit.slot=slotSel.value; updateStep3(); });
  }

  function computeCheckoutAssist(){
    const {issues, hard} = preIssues(); const selected=[...state.selectedModules]; const suggestions=[];
    if(selected.includes('cardio')) suggestions.push({type:'add', title:'Sinnvolle Erg√§nzung', desc:'Zu Herz & Stoffwechsel passt HbA1c (+CHF 9 ‚Äì Demo).'});
    if(issues.some(i=>i.title.includes('Biotin')) && selected.includes('hormone')) suggestions.push({type:'quality', title:'Biotin-Hinweis', desc:'Biotin kann Schilddr√ºsenwerte verf√§lschen ‚Äì ggf. verschieben.'});
    if(issues.some(i=>i.title.includes('Sport')) && (selected.includes('performance')||selected.includes('longevity'))) suggestions.push({type:'quality', title:'Sport-Hinweis', desc:'24‚Äì48h Sportpause f√ºr Verlaufsmessungen.'});
    if(selected.some(id=>['base','cardio','lipidplus'].includes(id)) && !state.pre.fasting) suggestions.push({type:'quality', title:'N√ºchtern empfohlen', desc:'F√ºr Glukose/Insulin/Lipide n√ºchtern testen.'});
    if(needsMorningSlot() && state.visit.slot.includes('16:00')) suggestions.push({type:'timing', title:'Zeitfenster Hinweis', desc:'Cortisol/Testosteron morgens (07‚Äì11 Uhr).'});
    const city=visitCities[state.visit.city]; if(city && !city.express) suggestions.push({type:'ops', title:'Express-Verf√ºgbarkeit', desc:`In ${city.label} (Demo) eingeschr√§nkt.`});
    return { hardBlock:hard, warnings:issues, suggestions };
  }

  function totalPrice(){
    let sum=0; const selectedCount=[...state.selectedModules].length;
    if(selectedCount>0){ const city=visitCities[state.visit.city]; if(city) sum+=city.fee; }
    [...state.selectedModules].forEach(id=>{ const m=moduleCatalog.find(x=>x.id===id); if(m) sum+=m.price; });
    if(state._addHbA1c) sum += 9;
    if(state.addOns.express) sum+=addOnPrices.express;
    if(state.addOns.doctor==='comment') sum+=addOnPrices.comment;
    if(state.addOns.doctor==='call') sum+=addOnPrices.call;
    return sum;
  }

  function renderCheckoutAssist(){
    const el=document.getElementById('checkoutAssist'); if(!el) return;
    const assist=computeCheckoutAssist(); state.checkout=assist;
    if(assist.hardBlock && state.addOns.express){ state.addOns.express=false; const ex=document.getElementById('addonExpress'); if(ex) ex.checked=false; toast('Express deaktiviert','Mehrere Pr√§analytik-Konflikte ‚Äì Qualit√§t vor Speed.'); }
    const warnCount=assist.warnings.length; const blocks=[];
    if(warnCount===0){
      blocks.push(`<div class="alert"><div class="dot ok"></div><div><p class="title">Checkout-Status: optimal</p><p class="desc">Keine relevanten Pr√§analytik-Hinweise.</p></div></div>`);
    } else {
      const level=assist.hardBlock?'danger':'warn'; const title=assist.hardBlock?'Checkout-Status: Wiederholung empfohlen':'Checkout-Status: Hinweise';
      const desc=assist.hardBlock?'Mehrere Faktoren schr√§nken die Vergleichbarkeit ein.':'Betroffene Werte werden markiert.';
      blocks.push(`<div class="alert"><div class="dot ${level}"></div><div><p class="title">${title}</p><p class="desc">${desc}</p></div></div>`);
      blocks.push(`<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px">${assist.warnings.map(w=>`<span class="chip">‚ö† ${w.title}</span>`).join('')}</div>`);
    }
    assist.suggestions.slice(0,3).forEach(s=>{
      const dot=s.type==='add'?'ok':'warn';
      blocks.push(`<div class="alert" style="margin-top:10px"><div class="dot ${dot}"></div><div><p class="title">${s.title}</p><p class="desc">${s.desc}</p></div></div>`);
    });
    el.innerHTML=blocks.join('');
  }

  function renderCart(){
    const lines=document.getElementById('cartLines'); const selected=[...state.selectedModules];
    const badge=document.getElementById('checkoutBadge'); if(badge) badge.textContent=`Warenkorb: ${selected.length} Module`;
    const entries=[]; const city=visitCities[state.visit.city];
    if(selected.length===0){ entries.push(`<div class="mini">Noch keine Module ausgew√§hlt.</div>`); }
    else selected.forEach(id=>{ const m=moduleCatalog.find(x=>x.id===id); if(m) entries.push(`<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">${m.name}</div><div class="meta">${m.desc}</div></div><div class="badge">${fmtCHF(m.price)}</div></div>`); });
    if(selected.length>0 && city){ entries.unshift(`<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">üè† Hausbesuch ${city.label}</div><div class="meta">${state.visit.slot?('Terminfenster: '+state.visit.slot):'Terminfenster: (bitte w√§hlen)'}</div></div><div class="badge">${fmtCHF(city.fee)}</div></div>`); }
    if(state._addHbA1c){ entries.push(`<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">‚ûï HbA1c (Add-on)</div><div class="meta">Assistenz-Vorschlag</div></div><div class="badge">CHF 9</div></div>`); }
    if(state.addOns.express){ entries.push(`<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">üöÄ Express-Auswertung</div><div class="meta">Priorisierte Verarbeitung</div></div><div class="badge">${fmtCHF(addOnPrices.express)}</div></div>`); }
    if(state.addOns.doctor!=='none'){ const price=state.addOns.doctor==='comment'?addOnPrices.comment:addOnPrices.call; const label=state.addOns.doctor==='comment'?'üßë‚Äç‚öïÔ∏è Medizinischer Kurzkommentar':'üìû Gesundheits-Call (15 min)'; entries.push(`<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">${label}</div><div class="meta">Optional</div></div><div class="badge">${fmtCHF(price)}</div></div>`); }
    if(lines) lines.innerHTML=entries.join('');

    const total=totalPrice(); const totalBadge=document.getElementById('totalBadge'); if(totalBadge) totalBadge.textContent=fmtCHF(total);
    const totalPriceEl=document.getElementById('totalPrice'); if(totalPriceEl) totalPriceEl.textContent=fmtCHF(total);
    const mini=document.getElementById('totalMini'); if(mini) mini.textContent=state.checkout.hardBlock?'Empfehlung: Abnahme verschieben oder Wiederholung einplanen.':'inkl. Laboranalyse & KI-Assistenz (ohne Diagnose)';

    const cartAlert=document.getElementById('cartAlert');
    if(cartAlert){
      if(selected.length===0) renderAlert(cartAlert,'warn','W√§hle mindestens ein Modul','F√ºr die Demo kannst du z. B. ‚ÄûHerz & Stoffwechsel‚Äú w√§hlen.');
      else{
        const {issues, hard}=preIssues();
        if(issues.length===0) renderAlert(cartAlert,'ok','Bereit f√ºr Checkout','Pr√§analytik sieht gut aus.');
        else renderAlert(cartAlert, hard?'danger':'warn', hard?'Qualit√§t: Wiederholung empfohlen':'Qualit√§t: Hinweise', hard?'Mehrere Faktoren verf√§lschen evtl. Ergebnisse.':'Betroffene Werte werden markiert.');
      }
    }

    const pay=document.getElementById('payBtn'); if(pay){
      pay.disabled=(selected.length===0)||!state.visit.covered; pay.style.opacity=pay.disabled?0.6:1;
    }
  }
  function updateStep3(){ renderModuleGrid(); renderVisitControls(); renderCheckoutAssist(); renderCart(); }

  // ---------------------------
  // Step 4 ‚Äì Customer dashboard
  // ---------------------------
  function seedCustomerReports(){
    state.customer.history = [
      { date:'2025-06-10', values:{'HbA1c':5.3,'HOMA-IR (berechnet)':1.9,'LDL':2.8,'Triglyceride':1.5,'TSH':2.0,'hs-CRP':1.1,'Ferritin':42,'Vitamin D (25-OH)':58,'Omega-3 Index (Demo)':4.0 }},
      { date:'2025-10-18', values:{'HbA1c':5.4,'HOMA-IR (berechnet)':2.1,'LDL':3.0,'Triglyceride':1.7,'TSH':2.1,'hs-CRP':0.9,'Ferritin':35,'Vitamin D (25-OH)':52,'Omega-3 Index (Demo)':4.1 }},
      { date:new Date().toISOString().slice(0,10), values:{
        'HbA1c': labs.metabolic.find(x=>x.key==='HbA1c').value,
        'HOMA-IR (berechnet)': labs.metabolic.find(x=>x.key==='HOMA-IR (berechnet)').value,
        'LDL': labs.lipids.find(x=>x.key==='LDL').value,
        'Triglyceride': labs.lipids.find(x=>x.key==='Triglyceride').value,
        'TSH': labs.thyroid.find(x=>x.key==='TSH').value,
        'hs-CRP': labs.inflammation.find(x=>x.key==='hs-CRP').value,
        'Ferritin': labs.micronutrients.find(x=>x.key==='Ferritin').value,
        'Vitamin D (25-OH)': labs.micronutrients.find(x=>x.key==='Vitamin D (25-OH)').value,
        'Omega-3 Index (Demo)': labs.micronutrients.find(x=>x.key==='Omega-3 Index (Demo)').value
      }}
    ];
    state.customer.reports = [
      { id:'r1', date: state.customer.history[2].date, title:'Report ‚Äì Heute', modules:['Basis-Check','Herz & Stoffwechsel','Lipide Advanced','Schilddr√ºse & Hormone','Mikron√§hrstoffe','Leber komplett','Niere & Elektrolyte','Entz√ºndung'], status:'fertig', badge:'ok' },
      { id:'r2', date:'2025-10-18', title:'Report ‚Äì Oktober', modules:['Herz & Stoffwechsel','Lipide Advanced'], status:'fertig', badge:'warn' },
      { id:'r3', date:'2025-06-10', title:'Report ‚Äì Juni', modules:['Basis-Check','Mikron√§hrstoffe'], status:'fertig', badge:'ok' }
    ];
    state.customer.activeReportId='r1';
  }
  function overallStatusFromLabs(){
    const all=Object.values(labs).flat(); const flags=all.map(t=>flagFor(t.value,t.low,t.high));
    const crit=flags.filter(f=>f==='danger').length; const warn=flags.filter(f=>f==='warn').length;
    if(crit>0) return { level:'danger', label:`Kritisch (${crit})` };
    if(warn>0) return { level:'warn', label:`Auff√§llig (${warn})` };
    return { level:'ok', label:'Unauff√§llig' };
  }
  function renderCustomerKPIs(){
    const last=state.customer.history[2]?.date||'‚Äî'; const st=overallStatusFromLabs();
    const next = state.checkout.hardBlock ? 'Wiederholung standardisieren' : (st.level==='danger'?'Zeitnahe Abkl√§rung':(st.level==='warn'?'Lifestyle + Verlauf':'Verlauf 6‚Äì12 Mon.'));
    const k1=document.getElementById('kpiLast'), k2=document.getElementById('kpiStatus'), k3=document.getElementById('kpiNext');
    if(k1) k1.textContent=last; if(k2) k2.textContent=st.label; if(k3) k3.textContent=next;
  }
  function renderReportsList(){
    const el=document.getElementById('custTimeline'); if(!el) return;
    const active=state.customer.activeReportId;
    el.innerHTML = state.customer.reports.map(r=>{
      const rb = r.badge==='danger'?{cls:'badge danger',label:'Kritisch'}: (r.badge==='warn'?{cls:'badge warn',label:'Auff√§llig'}:{cls:'badge ok',label:'OK'});
      return `<div class="item" data-report="${r.id}">
        <div><div style="font-weight:800; font-size:12px">${r.title} <span class="meta">(${r.date})</span></div>
        <div class="meta">Module: ${r.modules.join(' ‚Ä¢ ')} ‚Ä¢ Status: ${r.status}</div></div>
        <div style="display:flex; gap:8px; align-items:center">${active===r.id?'<span class="pill">aktiv</span>':''}<div class="${rb.cls}">${rb.label}</div></div>
      </div>`;
    }).join('');
    el.querySelectorAll('[data-report]').forEach(x=>{
      x.addEventListener('click', ()=>{ state.customer.activeReportId=x.getAttribute('data-report'); renderReport(); });
    });
  }
  function renderReport(){
    const r=state.customer.reports.find(x=>x.id===state.customer.activeReportId); if(!r) return;
    const title=document.getElementById('reportTitle'), meta=document.getElementById('reportMeta'), badge=document.getElementById('reportBadge');
    if(title) title.textContent=r.title; if(meta) meta.textContent=r.date; if(badge) { badge.textContent='OK'; badge.className='badge ok'; }
    const pre=document.getElementById('reportPre'); if(pre) pre.innerHTML = `<div class="mini">Pr√§analytik ber√ºcksichtigt: ${preIssues().issues.map(i=>i.title).join(' ‚Ä¢ ') || '‚Äî'}</div>`;
    const ai=document.getElementById('reportAI'); if(ai){ const st=overallStatusFromLabs(); renderAlert(ai, st.level, 'KI-Zusammenfassung', st.level==='ok'?'In den gezeigten Modulen keine Auff√§lligkeiten.':'Einige Auff√§lligkeiten ‚Äì siehe Module.'); }
  }
  function renderTrends(){
    const grid=document.getElementById('trendGrid'); if(!grid) return;
    const hist=state.customer.history; const keys=['HbA1c','LDL','Triglyceride','TSH','hs-CRP','Ferritin'];
    grid.innerHTML = keys.map(k=>{
      const vals=hist.map(h=>h.values[k]); const str=vals.map(v=>v??'‚Äî').join(' ‚Üí ');
      return `<div class="item" style="cursor:default"><div><div style="font-weight:700; font-size:12px">${k}</div><div class="meta">${str}</div></div><div class="pill">Verlauf</div></div>`;
    }).join('');
    const hint=document.getElementById('trendHint'); if(hint) hint.textContent='Demo-Trends aus den letzten drei Zeitpunkten.';
  }
  function renderNextSteps(){
    const box=document.getElementById('nextSteps'); if(!box) return;
    const st=overallStatusFromLabs(); const steps=[];
    if(state.checkout.hardBlock) steps.push({t:'Wiederholung standardisieren', d:'N√ºchtern, 24‚Äì48h kein Sport, Biotin pausieren (wenn vertretbar).'});
    if(st.level==='danger') steps.push({t:'Medizinische Abkl√§rung', d:'Bei starken Symptomen/notfallartigen Beschwerden sofort √§rztlich abkl√§ren.'});
    if(st.level!=='ok') steps.push({t:'Verlaufstest', d:'8‚Äì12 Wochen unter gleichen Bedingungen wiederholen.'});
    else steps.push({t:'Optionaler Verlauf', d:'6‚Äì12 Monate oder bei Symptomen/Lifestyle-√Ñnderungen.'});
    steps.push({t:'Module erg√§nzen', d:'Je nach Ziel: Mikron√§hrstoffe, Niere/Elektrolyte, gro√ües BB.'});
    box.innerHTML = steps.map(s=>`<div class="item"><div><div style="font-weight:800; font-size:12px">${s.t}</div><div class="meta">${s.d}</div></div><div class="pill">Assistenz</div></div>`).join('');
  }
  function renderVisitJourney(){
    const box=document.getElementById('visitJourney'), badge=document.getElementById('visitStatusBadge'), meta=document.getElementById('visitMeta');
    if(!box||!badge||!meta) return;
    const steps=[{k:'unbooked',label:'üßæ Nicht gebucht'},{k:'booked',label:'üìÖ Gebucht'},{k:'enroute',label:'üöó Unterwegs'},{k:'drawn',label:'ü©∏ Abgenommen'},{k:'lab',label:'üß™ Im Labor'},{k:'ready',label:'üìà Ergebnis bereit'}];
    const status=state.visit.status||'unbooked'; const activeIdx=Math.max(0, steps.findIndex(s=>s.k===status));
    box.innerHTML = steps.map((s,i)=>{ const cls=i===activeIdx?'badge':'pill'; const style=i===activeIdx?'background:rgba(96,165,250,.18); border:1px solid rgba(96,165,250,.35)':''; return `<span class="${cls}" style="${style}">${s.label}</span>`; }).join('');
    const city=visitCities[state.visit.city]; badge.textContent=status==='unbooked'?'‚Äî':'Aktiv';
    meta.textContent=status==='unbooked'?'Buche in Step 3 einen Hausbesuch.':(state.visit.when || `${city?city.label:'‚Äî'} ¬∑ ${state.visit.slot||'‚Äî'}`);
  }
  function renderCustomer(){ renderVisitJourney(); renderCustomerKPIs(); renderReportsList(); renderReport(); renderTrends(); renderNextSteps(); }

// ---------------------------
// Wiring: tabs
// ---------------------------
function setView(name){
  document.querySelectorAll('.tab').forEach(t=>{
    const active = t.getAttribute('data-view') === name;
    t.classList.toggle('active', active);
    t.setAttribute('aria-selected', active ? 'true' : 'false');
  });

  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const view = document.getElementById(`view-${name}`);
  if (view) view.classList.add('active');

  const pill = document.getElementById('statusPill');
  if (pill){
    if (name === 'step12') pill.textContent = 'Pr√§analytik & KI aktiv';
    if (name === 'step3')  pill.textContent = 'Checkout-Logik aktiv';
    if (name === 'step4')  pill.textContent = 'Kunden-Dashboard aktiv';
  }

  // --- NEU: Orders automatisch laden, wenn Step 4 aktiv wird ---
  if (name === 'step4') {
    const emailInput = document.getElementById('ordersEmail');
    const email = (emailInput?.value || localStorage.getItem('demoEmail') || '').trim();
    if (email) loadOrders(email);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=> setView(t.getAttribute('data-view')));
  });
});

  // ---------------------------
  // Inputs (Step 1)
  // ---------------------------
  function bindPreInputs(){
    const map=[['fasting','fasting','checkbox'],['hoursSinceMeal','hoursSinceMeal','number'],['coffee','coffee','select'],['alcohol','alcohol','select'],['biotin','biotin','select'],['sport','sport','select'],['smoke','smoke','select']];
    map.forEach(([id,key,type])=>{
      const el=document.getElementById(id); if(!el) return;
      const update=()=>{ if(type==='checkbox') state.pre[key]=el.checked; else if(type==='number') state.pre[key]=Number(el.value||0); else state.pre[key]=el.value; renderAllStep12(); updateStep3(); };
      el.addEventListener('change', update); el.addEventListener('input', update);
    });
  }

  // ---------------------------
  // Add-ons & Buttons (Step 3)
  // ---------------------------
  function bindAddOns(){
    const ex=document.getElementById('addonExpress'); if(ex) ex.addEventListener('change', ()=>{ const assist=computeCheckoutAssist(); const city=visitCities[state.visit.city]; if(((city && !city.express) || assist.hardBlock) && ex.checked){ ex.checked=false; state.addOns.express=false; toast('Express nicht m√∂glich', (city && !city.express)?`In ${city.label} (Demo) nicht verf√ºgbar.`:'Mehrere Pr√§analytik-Konflikte.'); } else { state.addOns.express=ex.checked; } updateStep3(); });
    const doc=document.getElementById('addonDoctor'); if(doc) doc.addEventListener('change', ()=>{ state.addOns.doctor=doc.value; updateStep3(); });
    const pay=document.getElementById('payBtn'); if(pay) pay.addEventListener('click', ()=>{
      const selected=[...state.selectedModules]; if(selected.length===0) return;
      const total=totalPrice(); const city=visitCities[state.visit.city]; const slot=state.visit.slot||'‚Äî'; const when=`N√§chster Hausbesuch: ${city?city.label:'‚Äî'} ¬∑ ${slot}`;
      state.visit.status='booked'; state.visit.when=when;
      const assist=computeCheckoutAssist();
      if(assist.hardBlock) toast('Buchung abgeschlossen (Demo)', `Gesamt: ${fmtCHF(total)}. ${when}. Hinweis: Wiederholung empfohlen.`); else toast('Buchung abgeschlossen (Demo)', `Gesamt: ${fmtCHF(total)}. ${when}. Ergebnisbericht folgt nach Laborauswertung.`);
      renderCustomer(); setView('step4');
    });
  }

  // ---------------------------
  // Customer actions (Step 4)
  // ---------------------------
  function bindCustomerActions(){
    const d=document.getElementById('btnDownload'); if(d) d.addEventListener('click', ()=> toast('Download (Demo)','Hier w√ºrde ein PDF-Report erzeugt.'));
    const c=document.getElementById('btnCompare'); if(c) c.addEventListener('click', ()=> toast('Verlauf (Demo)','Vergleichsansicht folgt in echter App.'));
    const r=document.getElementById('btnRepeat'); if(r) r.addEventListener('click', ()=>{ const {hard}=preIssues(); toast('Verlaufstest (Demo)', hard?'Erst standardisieren (n√ºchtern/kein Sport/kein Biotin), dann planen.':'Empfehlung: Verlauf in 8‚Äì12 Wochen.'); });
  }

  // ---------------------------
  // Demo & reset
  // ---------------------------
  function loadDemo(){
    state.pre={ fasting:false, hoursSinceMeal:3, coffee:'sweet', alcohol:'yes', biotin:'yes', sport:'yes', smoke:'yes' };
    ['fasting','hoursSinceMeal','coffee','alcohol','biotin','sport','smoke'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=state.pre.fasting; else el.value=state.pre[id]??state.pre[id.replace(/^[a-z]+/,'')]; });
    state.selectedModules=new Set(['cardio','hormone']); state.addOns.express=false; state.addOns.doctor='comment'; state._addHbA1c=true;
    const ex=document.getElementById('addonExpress'); if(ex) ex.checked=state.addOns.express; const doc=document.getElementById('addonDoctor'); if(doc) doc.value=state.addOns.doctor;
    seedCustomerReports(); renderAllStep12(); updateStep3(); renderCustomer(); toast('Demo geladen','Pr√§analytik-Hinweise, Checkout & Dashboard aktiv.');
  }
  function resetAll(){
    state.pre={ fasting:false, hoursSinceMeal:0, coffee:'no', alcohol:'no', biotin:'no', sport:'no', smoke:'no' };
    state.selectedModules=new Set(); state.addOns={ express:false, doctor:'none' }; state._addHbA1c=false; seedCustomerReports(); state.customer.activeReportId=null;
    ['fasting','hoursSinceMeal','coffee','alcohol','biotin','sport','smoke'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else el.value = (id==='hoursSinceMeal'?0:'no'); });
    const ex=document.getElementById('addonExpress'); if(ex) ex.checked=false; const doc=document.getElementById('addonDoctor'); if(doc) doc.value='none';
    renderAllStep12(); updateStep3(); renderCustomer(); toast('Zur√ºckgesetzt','Alle Demo-Einstellungen zur√ºckgesetzt.');
  }

// ---------------------------
// Init
// ---------------------------
function init(){
  bindPreInputs(); renderAllStep12(); bindAddOns(); bindVisit(); updateStep3();
  seedCustomerReports(); renderCustomer(); bindCustomerActions();
  const demo=document.getElementById('demoBtn'); if(demo) demo.addEventListener('click', loadDemo);
  const reset=document.getElementById('resetBtn'); if(reset) reset.addEventListener('click', resetAll);
  bindOrdersUI();                // NEU: Orders-UI binden (E-Mail-Feld + Button)
  setView('step12');
}
document.addEventListener('DOMContentLoaded', init);
</script>
  <script>
async function loadOrders(email){
  const statusEl = document.getElementById('ordersStatus');
  const tbody = document.querySelector('#ordersTable tbody');
  if (statusEl) statusEl.textContent = 'Laden...';
  if (tbody) tbody.innerHTML = '';
  try{
    const res = await fetch('/api/orders/list?email=' + encodeURIComponent(email) + '&limit=100');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const { orders } = await res.json();
    if(!orders?.length){
      if(statusEl) statusEl.textContent = 'Keine Bestellungen gefunden.';
      return;
    }
    for (const o of orders){
      const tr = document.createElement('tr'); tr.className='trow';
      const dt = new Date(o.created_at);
      const amount = (o.amount_total/100).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      const pdf = o.receipt_url ? ' <a href="'+o.receipt_url+'" target="_blank" rel="noopener">PDF</a>' : '';
      tr.innerHTML = `
        <td>${dt.toLocaleString()}</td>
        <td>${o.status||''}</td>
        <td>${amount}</td>
        <td>${(o.currency||'').toUpperCase()}</td>
        <td>${o.city||''}</td>
        <td>${o.slot||''}</td>
        <td><code style="font-family:var(--mono)">${o.session_id||''}</code>${pdf}</td>`;
      tbody.appendChild(tr);
    }
    if (statusEl) statusEl.textContent = `${orders.length} Bestellung(en) geladen.`;
  }catch(e){
    console.error(e);
    if (statusEl) statusEl.textContent = 'Fehler beim Laden.';
  }
}

function bindOrdersUI(){
  const emailInput = document.getElementById('ordersEmail');
  const btn = document.getElementById('ordersRefresh');
  if(!emailInput || !btn) return;
  const demoEmail = localStorage.getItem('demoEmail') || '';
  if (demoEmail) emailInput.value = demoEmail;
  btn.addEventListener('click', ()=>{
    const email = (emailInput.value||'').trim();
    if(!email){ alert('Bitte E-Mail eingeben.'); return; }
    loadOrders(email);
  });
}
</script>
 <script>
  // Step 3: realer Checkout ohne Umbau ‚Äì wir greifen den Klick ab
  function buildCartItems(){
    const items = [];
    const sel = [...state.selectedModules];

    // Hausbesuch-Fee nur, wenn mind. ein Modul gew√§hlt ist
    if (sel.length > 0) {
      const city = visitCities[state.visit.city];
      if (city) items.push({ name: `üè† Hausbesuch ${city.label}`, price: Math.round(city.fee) });
    }
    // Module
    sel.forEach(id => {
      const m = moduleCatalog.find(x => x.id === id);
      if (m) items.push({ name: m.name, price: Math.round(m.price) });
    });
    // Add-ons
    if (state._addHbA1c) items.push({ name: "‚ûï HbA1c (Add-on)", price: 9 });
    if (state.addOns?.express) items.push({ name: "üöÄ Express-Auswertung",  price: Math.round((addOnPrices?.express)||19) });
    if (state.addOns?.doctor === "comment") items.push({ name: "üßë‚Äç‚öïÔ∏è Kurzkommentar", price: Math.round((addOnPrices?.comment)||29) });
    if (state.addOns?.doctor === "call")    items.push({ name: "üìû 15-min Call",     price: Math.round((addOnPrices?.call)||49) });
    return items;
  }

  async function realCheckout(){
    const items = buildCartItems();
    if (!items.length) { toast?.("Checkout", "Bitte zuerst Module w√§hlen."); return; }
    if (!state.visit?.covered) { toast?.("Checkout", "Bitte g√ºltige PLZ im Step 3 angeben."); return; }

    const body = { items, city: state.visit.city, slot: state.visit.slot || "" };
    const res = await fetch('/api/checkout', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    }).then(r=>r.json()).catch(()=>({}));

    if (res?.url) location.href = res.url;  // Stripe Payment Link ODER /success.html (Demo)
    else toast?.("Checkout-Fehler", res?.error || "Unbekannter Fehler");
  }

  // Bestehenden Simulations-Handler elegant aushebeln (capture + stopImmediatePropagation)
  window.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('payBtn');
    if (!btn) return;
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopImmediatePropagation();
      realCheckout();
    }, true); // capture=true
  });
</script>
 </body>
</html>
